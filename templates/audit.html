<!DOCTYPE html>
<html>
<head>
    <title>Audit Information</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="datetime-local"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #nav-buttons {
            margin-bottom: 20px;
        }
        #stands {
            margin-top: 20px;
        }
        .stand {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chapitre {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Audit Information</h1>
    <div id="nav-buttons"></div>
    <form id="auditForm">
        <!-- Existing form fields -->
        <!-- Pre-populated fields for testing -->
        <div class="form-group">
            <label for="auditDate">Date de l'audit</label>
            <input type="date" id="auditDate" name="auditDate" required value="2024-06-05">
        </div>
        <div class="form-group">
            <label for="restaurantName">Nom du restaurant</label>
            <input type="text" id="restaurantName" name="restaurantName" required value="Le Bon Repas">
        </div>
        <div class="form-group">
            <label for="manager">Gestionnaire</label>
            <input type="text" id="manager" name="manager" required value="Jean Dupont">
        </div>
        <div class="form-group">
            <label for="contactFirstName">Personne rencontrée - Prénom</label>
            <input type="text" id="contactFirstName" name="contactFirstName" required value="Marie">
        </div>
        <div class="form-group">
            <label for="contactLastName">Personne rencontrée - Nom</label>
            <input type="text" id="contactLastName" name="contactLastName" required value="Curie">
        </div>
        <div class="form-group">
            <label for="contactFunction">Personne rencontrée - Fonction</label>
            <input type="text" id="contactFunction" name="contactFunction" required value="Chef de cuisine">
        </div>
        <div class="form-group">
            <label for="averageMeals">Nombre de repas jour servis en moyenne</label>
            <input type="number" id="averageMeals" name="averageMeals" required value="200">
        </div>
        <div class="form-group">
            <label for="seatingCapacity">Nombre de places assises</label>
            <input type="number" id="seatingCapacity" name="seatingCapacity" required value="100">
        </div>
        <div class="form-group">
            <label for="overallTurnoverRate">Taux de rotation global</label>
            <input type="number" id="overallTurnoverRate" name="overallTurnoverRate" step="0.01" readonly>
        </div>
        <div class="form-group">
            <label for="mealsServedToday">Nombre de repas servis ce jour</label>
            <input type="number" id="mealsServedToday" name="mealsServedToday" required value="150">
        </div>
        <div class="form-group">
            <label for="dailyTurnoverRate">Taux de rotation du jour</label>
            <input type="number" id="dailyTurnoverRate" name="dailyTurnoverRate" step="0.01" readonly>
        </div>
        <div class="form-group">
            <label for="selfServiceStart">Horaires du self début</label>
            <input type="time" id="selfServiceStart" name="selfServiceStart" required value="11:30">
        </div>
        <div class="form-group">
            <label for="selfServiceEnd">Horaires du self fin</label>
            <input type="time" id="selfServiceEnd" name="selfServiceEnd" required value="14:00">
        </div>
        <div class="form-group">
            <label for="previousAuditDates">Date(s) de(s) l'audit(s) précédent(s)</label>
            <input type="date" id="previousAuditDates" name="previousAuditDates" value="2023-06-04">
        </div>
        <button type="button" onclick="addStand()">Auditer un stand</button>
        <button type="submit">Submit</button>
    </form>
    <div id="stands"></div>

    <script>
        let auditId = localStorage.getItem('currentAuditId') || generateAuditId();
        let audits = JSON.parse(localStorage.getItem('audits')) || {};

        function generateAuditId() {
            const id = 'audit-' + Date.now();
            localStorage.setItem('currentAuditId', id);
            return id;
        }

        function saveAuditData() {
            const formData = new FormData(document.getElementById('auditForm'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Calculate Taux de rotation
            const repasServis = parseInt(data['mealsServedToday']);
            const repasMoyenne = parseInt(data['averageMeals']);
            const placesAssises = parseInt(data['seatingCapacity']);
            const tauxRotationGlobal = (repasMoyenne / (placesAssises * 0.8)).toFixed(2);
            const tauxRotationJour = (repasServis / (placesAssises * 0.8)).toFixed(2);
            data['overallTurnoverRate'] = tauxRotationGlobal;
            data['dailyTurnoverRate'] = tauxRotationJour;

            document.getElementById('overallTurnoverRate').value = tauxRotationGlobal;
            document.getElementById('dailyTurnoverRate').value = tauxRotationJour;

            audits[auditId] = audits[auditId] || { sections: [] };
            audits[auditId].data = data;

            localStorage.setItem('audits', JSON.stringify(audits));
        }

        document.getElementById('auditForm').addEventListener('submit', function(event) {
            event.preventDefault();
            saveAuditData();
            alert('Audit data saved locally!');
        });

        function addStand() {
            const standIndex = audits[auditId].sections.length;
            const standDiv = document.createElement('div');
            standDiv.className = 'stand';
            standDiv.innerHTML = `
                <h3>Stand ${standIndex + 1}</h3>
                <div class="form-group">
                    <label for="standName${standIndex}">Nom du stand</label>
                    <input type="text" id="standName${standIndex}" name="standName${standIndex}" required>
                </div>
                <div class="form-group">
                    <label for="standDetails${standIndex}">Détails du stand</label>
                    <input type="text" id="standDetails${standIndex}" name="standDetails${standIndex}" required>
                </div>
                <button type="button" onclick="addChapitre(${standIndex})">Ajouter un Chapitre</button>
                <div id="chapitres${standIndex}" class="chapitre"></div>
            `;
            document.getElementById('stands').appendChild(standDiv);

            audits[auditId].sections.push({
                standName: '',
                standDetails: '',
                chapitres: []
            });
            saveAuditData();
        }

        function addChapitre(standIndex) {
            const chapitreType = prompt("Entrez le type de Chapitre à ajouter (e.g., 'Le Personnel', 'Les Affichages'):");
            if (chapitreType) {
                const chapitreDiv = document.createElement('div');
                chapitreDiv.className = 'chapitre';
                chapitreDiv.innerHTML = `
                    <h4>Chapitre: ${chapitreType}</h4>
                    ${createChapitreFields(standIndex, chapitreType)}
                `;
                document.getElementById(`chapitres${standIndex}`).appendChild(chapitreDiv);

                audits[auditId].sections[standIndex].chapitres.push({
                    type: chapitreType,
                    data: {}
                });
                saveAuditData();
            }
        }

        function createChapitreFields(standIndex, chapitreType) {
            const questions = getQuestionsForChapitre(chapitreType);
            let fieldsHtml = '';
            questions.forEach((question, index) => {
                fieldsHtml += `
                    <div class="form-group">
                        <label for="question${standIndex}_${chapitreType}_${index}">${question}</label>
                        <select id="question${standIndex}_${chapitreType}_${index}" name="question${standIndex}_${chapitreType}_${index}">
                            <option value="Conforme">Conforme</option>
                            <option value="Partiellement Conforme">Partiellement Conforme</option>
                            <option value="Non-Conforme">Non-Conforme</option>
                        </select>
                    </div>
                `;
            });
            return fieldsHtml;
        }

        function getQuestionsForChapitre(chapitreType) {
            const questions = {
                "Le Personnel": [
                    "Respect des procédures d’hygiène (absence d’utilisation de torchon, port de la coiffe règlementaire, port de bijoux, etc.)",
                    "Uniformité des tenues",
                    "Etat des tenues",
                    "Propreté des tenues",
                    "Le sourire",
                    "L'amabilité",
                    "La politesse",
                    "La gestuelle",
                    "La réactivité",
                    "La rapidité de service",
                    "L'information",
                    "Le conseil"
                ],
                "Les Affichages": [
                    "Affichage des horaires d’ouverture du restaurant",
                    "Informations sur les plats / menus",
                    "Informations sur les créneaux horaires à éviter"
                ]
                // Add more Chapitres and their questions here as needed
            };
            return questions[chapitreType] || [];
        }

        function loadAuditData(id) {
            const audit = audits[id];
            if (audit) {
                for (const [key, value] of Object.entries(audit.data)) {
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = value;
                    }
                }

                document.getElementById('stands').innerHTML = '';
                audit.sections.forEach((section, index) => {
                    const standDiv = document.createElement('div');
                    standDiv.className = 'stand';
                    standDiv.innerHTML = `
                        <h3>Stand ${index + 1}</h3>
                        <div class="form-group">
                            <label for="standName${index}">Nom du stand</label>
                            <input type="text" id="standName${index}" name="standName${index}" value="${section.standName}" required>
                        </div>
                        <div class="form-group">
                            <label for="standDetails${index}">Détails du stand</label>
                            <input type="text" id="standDetails${index}" name="standDetails${index}" value="${section.standDetails}" required>
                        </div>
                        <button type="button" onclick="addChapitre(${index})">Ajouter un Chapitre</button>
                        <div id="chapitres${index}" class="chapitre">${loadChapitres(section.chapitres, index)}</div>
                    `;
                    document.getElementById('stands').appendChild(standDiv);
                });
            }
        }

        function loadChapitres(chapitres, standIndex) {
            let chapitresHtml = '';
            chapitres.forEach((chapitre, chapitreIndex) => {
                chapitresHtml += `
                    <div class="chapitre">
                        <h4>Chapitre: ${chapitre.type}</h4>
                        ${createChapitreFields(standIndex, chapitre.type, chapitre.data)}
                    </div>
                `;
            });
            return chapitresHtml;
        }

        function createChapitreFields(standIndex, chapitreType, data = {}) {
            const questions = getQuestionsForChapitre(chapitreType);
            let fieldsHtml = '';
            questions.forEach((question, index) => {
                fieldsHtml += `
                    <div class="form-group">
                        <label for="question${standIndex}_${chapitreType}_${index}">${question}</label>
                        <select id="question${standIndex}_${chapitreType}_${index}" name="question${standIndex}_${chapitreType}_${index}">
                            <option value="Conforme" ${data[`question${standIndex}_${chapitreType}_${index}`] === 'Conforme' ? 'selected' : ''}>Conforme</option>
                            <option value="Partiellement Conforme" ${data[`question${standIndex}_${chapitreType}_${index}`] === 'Partiellement Conforme' ? 'selected' : ''}>Partiellement Conforme</option>
                            <option value="Non-Conforme" ${data[`question${standIndex}_${chapitreType}_${index}`] === 'Non-Conforme' ? 'selected' : ''}>Non-Conforme</option>
                        </select>
                    </div>
                `;
            });
            return fieldsHtml;
        }

        function createNavButtons() {
            const navDiv = document.getElementById('nav-buttons');
            navDiv.innerHTML = '';
            for (const id in audits) {
                const button = document.createElement('button');
                button.innerText = `Audit ${id}`;
                button.onclick = function() {
                    auditId = id;
                    localStorage.setItem('currentAuditId', id);
                    loadAuditData(id);
                };
                navDiv.appendChild(button);
            }
        }

        createNavButtons();
        loadAuditData(auditId);
    </script>
</body>
</html>
